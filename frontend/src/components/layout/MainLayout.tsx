'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useEffect, useState } from 'react';
import { useStore } from '@/store/store';
import { Layers, Filter, FileText, Edit3, Map, Clock, BarChart3, ArrowLeft } from 'lucide-react';

interface MainLayoutProps {
  children: React.ReactNode;
}

const navItems = [
  { href: '/slovolov-pro/clusters', label: 'Кластеры', Icon: Layers },
  { href: '/slovolov-pro/filters', label: 'Фильтры', Icon: Filter },
  { href: '/slovolov-pro/models', label: 'Модели', Icon: FileText },
  { href: '/slovolov-pro/editor', label: 'Редактор', Icon: Edit3 },
  { href: '/slovolov-pro/map', label: 'Карта', Icon: Map },
  { href: '/slovolov-pro/topvisor', label: 'Топвизор', Icon: BarChart3, matchPrefix: true },
  { href: '/slovolov-pro/history', label: 'История', Icon: Clock },
];

// Сохраняем последнюю посещённую страницу для каждого раздела
const lastVisitedKey = 'slovolov-last-visited';

function getLastVisited(): Record<string, string> {
  if (typeof window === 'undefined') return {};
  try {
    return JSON.parse(localStorage.getItem(lastVisitedKey) || '{}');
  } catch {
    return {};
  }
}

function setLastVisited(section: string, path: string) {
  if (typeof window === 'undefined') return;
  try {
    const current = getLastVisited();
    current[section] = path;
    localStorage.setItem(lastVisitedKey, JSON.stringify(current));
  } catch {
    // ignore
  }
}

export default function MainLayout({ children }: MainLayoutProps) {
  const pathname = usePathname();
  const { queries, filters, clusters, isLoading, loadData, remainingQuota, totalQuota } = useStore();
  const [lastVisited, setLastVisitedState] = useState<Record<string, string>>({});

  useEffect(() => {
    loadData();
    setLastVisitedState(getLastVisited());
  }, [loadData]);

  // Сохраняем текущий путь как последний посещённый для раздела
  useEffect(() => {
    if (!pathname) return;
    
    // Находим раздел, к которому относится текущий путь
    for (const item of navItems) {
      if (item.matchPrefix && pathname.startsWith(item.href)) {
        setLastVisited(item.href, pathname);
        setLastVisitedState(prev => ({ ...prev, [item.href]: pathname }));
        break;
      } else if (pathname === item.href) {
        setLastVisited(item.href, pathname);
        setLastVisitedState(prev => ({ ...prev, [item.href]: pathname }));
        break;
      }
    }
  }, [pathname]);

  // Проверяем, активен ли элемент навигации
  const isNavItemActive = (item: typeof navItems[0]) => {
    if (item.matchPrefix) {
      return pathname.startsWith(item.href);
    }
    return pathname === item.href;
  };

  // Получаем ссылку для элемента навигации (с учётом последнего посещённого)
  const getNavItemHref = (item: typeof navItems[0]) => {
    if (item.matchPrefix && lastVisited[item.href]) {
      return lastVisited[item.href];
    }
    return item.href;
  };

  return (
    <div className="h-screen flex flex-col">
      {/* Header */}
      <header className="h-12 bg-[#1a1a1a] border-b border-white/5 flex items-center px-4">
        <Link
          href="/"
          className="flex items-center justify-center w-8 h-8 rounded-lg text-white/40 hover:text-white/70 hover:bg-white/5 transition-all mr-3"
          title="На главную"
        >
          <ArrowLeft className="w-4 h-4" strokeWidth={2} />
        </Link>
        <Link href="/slovolov-pro/clusters" className="flex items-center gap-2 mr-6">
          <svg width="212" height="40" viewBox="0 0 532 100" fill="none" xmlns="http://www.w3.org/2000/svg" className="h-8">
            <path d="M338.055 29.864C339.039 29.768 340.071 29.684 341.151 29.612C342.231 29.54 343.263 29.48 344.247 29.432C345.255 29.384 346.095 29.36 346.767 29.36C350.823 29.36 353.859 30.188 355.875 31.844C357.915 33.5 358.935 35.972 358.935 39.26C358.935 42.452 357.987 44.9 356.091 46.604C354.195 48.308 351.459 49.16 347.883 49.16C347.067 49.16 346.107 49.124 345.003 49.052C343.923 48.956 342.807 48.824 341.655 48.656V42.896C342.567 43.04 343.515 43.16 344.499 43.256C345.483 43.352 346.299 43.4 346.947 43.4C348.531 43.4 349.695 43.064 350.439 42.392C351.183 41.72 351.555 40.676 351.555 39.26C351.555 37.844 351.183 36.8 350.439 36.128C349.695 35.456 348.531 35.12 346.947 35.12C346.347 35.12 345.615 35.168 344.751 35.264C343.911 35.336 342.999 35.456 342.015 35.624L345.255 32.24V56H338.055V29.864ZM361.961 29.864C362.993 29.768 364.061 29.684 365.165 29.612C366.293 29.54 367.373 29.48 368.405 29.432C369.437 29.384 370.313 29.36 371.033 29.36C375.089 29.36 378.065 30.08 379.961 31.52C381.881 32.936 382.841 35.144 382.841 38.144C382.841 41.144 381.881 43.364 379.961 44.804C378.065 46.22 375.089 46.928 371.033 46.928C370.241 46.928 369.341 46.904 368.333 46.856C367.349 46.808 366.449 46.76 365.633 46.712L365.921 41.168C366.809 41.312 367.781 41.432 368.837 41.528C369.893 41.624 370.745 41.672 371.393 41.672C372.809 41.672 373.841 41.408 374.489 40.88C375.137 40.352 375.461 39.524 375.461 38.396C375.461 37.268 375.137 36.44 374.489 35.912C373.841 35.384 372.809 35.12 371.393 35.12C370.745 35.12 369.893 35.168 368.837 35.264C367.781 35.36 366.809 35.48 365.921 35.624L369.161 32.24V56H361.961V29.864ZM376.433 56L367.109 44.228H374.957L384.641 56H376.433ZM399.908 56.36C397.052 56.36 394.592 55.832 392.528 54.776C390.488 53.696 388.928 52.148 387.848 50.132C386.768 48.116 386.228 45.692 386.228 42.86C386.228 40.028 386.768 37.604 387.848 35.588C388.928 33.572 390.488 32.036 392.528 30.98C394.592 29.9 397.052 29.36 399.908 29.36C402.788 29.36 405.248 29.9 407.288 30.98C409.328 32.036 410.888 33.572 411.968 35.588C413.048 37.604 413.588 40.028 413.588 42.86C413.588 45.692 413.048 48.116 411.968 50.132C410.888 52.148 409.328 53.696 407.288 54.776C405.248 55.832 402.788 56.36 399.908 56.36ZM399.908 50.24C401.3 50.24 402.464 49.964 403.4 49.412C404.336 48.86 405.032 48.044 405.488 46.964C405.968 45.86 406.208 44.492 406.208 42.86C406.208 41.228 405.968 39.872 405.488 38.792C405.032 37.688 404.336 36.86 403.4 36.308C402.464 35.756 401.3 35.48 399.908 35.48C398.516 35.48 397.352 35.756 396.416 36.308C395.48 36.86 394.772 37.688 394.292 38.792C393.836 39.872 393.608 41.228 393.608 42.86C393.608 44.492 393.836 45.86 394.292 46.964C394.772 48.044 395.48 48.86 396.416 49.412C397.352 49.964 398.516 50.24 399.908 50.24Z" fill="#22D3EE"/>
            <path d="M19.968 73.96C16.64 73.96 13.44 73.6187 10.368 72.936C7.33867 72.2107 4.88533 71.208 3.008 69.928C2.368 69.4587 2.048 69.032 2.048 68.648C2.048 68.392 2.15467 68.0933 2.368 67.752L4.992 63.592C5.248 63.1653 5.52533 62.952 5.824 62.952C6.08 62.952 6.4 63.08 6.784 63.336C8.36267 64.232 10.176 64.9573 12.224 65.512C14.272 66.0667 16.3413 66.344 18.432 66.344C20.9067 66.344 22.7413 65.96 23.936 65.192C25.1307 64.3813 25.728 63.1227 25.728 61.416C25.728 60.264 25.4293 59.3253 24.832 58.6C24.2773 57.8747 23.424 57.2347 22.272 56.68C21.1627 56.1253 19.4347 55.4 17.088 54.504C14.3573 53.48 12.032 52.4347 10.112 51.368C8.23467 50.3013 6.67733 48.936 5.44 47.272C4.24533 45.5653 3.648 43.496 3.648 41.064C3.648 37.0107 5.12 33.9173 8.064 31.784C11.008 29.608 14.8907 28.52 19.712 28.52C26.0693 28.52 30.9333 29.7147 34.304 32.104C34.944 32.616 35.264 33.0427 35.264 33.384C35.264 33.64 35.1573 33.9387 34.944 34.28L32.32 38.44C32.064 38.8667 31.7867 39.08 31.488 39.08C31.232 39.08 30.912 38.952 30.528 38.696C27.9253 36.9893 24.768 36.136 21.056 36.136C16.448 36.136 14.144 37.8 14.144 41.128C14.144 42.2373 14.4 43.1547 14.912 43.88C15.4667 44.5627 16.2133 45.16 17.152 45.672C18.0907 46.1413 19.5627 46.76 21.568 47.528L23.36 48.232C26.4747 49.4693 28.928 50.6427 30.72 51.752C32.512 52.8187 33.8773 54.1413 34.816 55.72C35.7973 57.2987 36.288 59.3253 36.288 61.8C36.288 65.512 34.88 68.4773 32.064 70.696C29.2907 72.872 25.2587 73.96 19.968 73.96ZM44.394 73C43.37 73 42.6233 72.7867 42.154 72.36C41.7273 71.8907 41.514 71.1867 41.514 70.248V32.296C41.514 31.3573 41.7273 30.6533 42.154 30.184C42.6233 29.7147 43.37 29.48 44.394 29.48H49.194C50.2607 29.48 51.0073 29.7147 51.434 30.184C51.8607 30.6107 52.074 31.3147 52.074 32.296V65.256H70.122C71.146 65.256 71.85 65.4693 72.234 65.896C72.618 66.3227 72.81 67.0267 72.81 68.008V70.312C72.81 71.2933 72.618 71.9973 72.234 72.424C71.85 72.808 71.146 73 70.122 73H44.394ZM94.945 73.96C87.6917 73.96 82.145 71.976 78.305 68.008C74.5077 64.04 72.609 58.4507 72.609 51.24C72.609 44.0293 74.5077 38.44 78.305 34.472C82.145 30.504 87.6917 28.52 94.945 28.52C102.156 28.52 107.66 30.504 111.457 34.472C115.297 38.44 117.217 44.0293 117.217 51.24C117.217 58.4507 115.297 64.04 111.457 68.008C107.66 71.976 102.156 73.96 94.945 73.96ZM94.945 66.344C98.8277 66.344 101.75 65.0853 103.713 62.568C105.718 60.008 106.721 56.232 106.721 51.24C106.721 46.248 105.718 42.4933 103.713 39.976C101.75 37.416 98.8277 36.136 94.945 36.136C91.0197 36.136 88.0543 37.416 86.049 39.976C84.0863 42.4933 83.105 46.248 83.105 51.24C83.105 56.232 84.0863 60.008 86.049 62.568C88.0543 65.0853 91.0197 66.344 94.945 66.344ZM135.928 73C135.245 73 134.733 72.872 134.392 72.616C134.051 72.36 133.731 71.8693 133.432 71.144L117.24 31.592C117.112 31.208 117.048 30.8667 117.048 30.568C117.048 29.8427 117.432 29.48 118.2 29.48H125.88C126.477 29.48 126.925 29.608 127.224 29.864C127.565 30.12 127.821 30.4827 127.992 30.952L138.232 58.408L148.472 30.952C148.813 29.9707 149.539 29.48 150.648 29.48H158.328C159.096 29.48 159.48 29.8427 159.48 30.568C159.48 30.8667 159.416 31.208 159.288 31.592L143.16 71.144C142.861 71.8693 142.52 72.36 142.136 72.616C141.795 72.872 141.283 73 140.6 73H135.928ZM181.633 73.96C174.379 73.96 168.833 71.976 164.993 68.008C161.195 64.04 159.297 58.4507 159.297 51.24C159.297 44.0293 161.195 38.44 164.993 34.472C168.833 30.504 174.379 28.52 181.633 28.52C188.843 28.52 194.347 30.504 198.145 34.472C201.985 38.44 203.905 44.0293 203.905 51.24C203.905 58.4507 201.985 64.04 198.145 68.008C194.347 71.976 188.843 73.96 181.633 73.96ZM181.633 66.344C185.515 66.344 188.438 65.0853 190.401 62.568C192.406 60.008 193.409 56.232 193.409 51.24C193.409 46.248 192.406 42.4933 190.401 39.976C188.438 37.416 185.515 36.136 181.633 36.136C177.707 36.136 174.742 37.416 172.737 39.976C170.774 42.4933 169.793 46.248 169.793 51.24C169.793 56.232 170.774 60.008 172.737 62.568C174.742 65.0853 177.707 66.344 181.633 66.344ZM212.019 73C210.995 73 210.248 72.7867 209.779 72.36C209.352 71.8907 209.139 71.1867 209.139 70.248V32.296C209.139 31.3573 209.352 30.6533 209.779 30.184C210.248 29.7147 210.995 29.48 212.019 29.48H216.819C217.886 29.48 218.632 29.7147 219.059 30.184C219.486 30.6107 219.699 31.3147 219.699 32.296V65.256H237.747C238.771 65.256 239.475 65.4693 239.859 65.896C240.243 66.3227 240.435 67.0267 240.435 68.008V70.312C240.435 71.2933 240.243 71.9973 239.859 72.424C239.475 72.808 238.771 73 237.747 73H212.019ZM262.57 73.96C255.317 73.96 249.77 71.976 245.93 68.008C242.133 64.04 240.234 58.4507 240.234 51.24C240.234 44.0293 242.133 38.44 245.93 34.472C249.77 30.504 255.317 28.52 262.57 28.52C269.781 28.52 275.285 30.504 279.082 34.472C282.922 38.44 284.842 44.0293 284.842 51.24C284.842 58.4507 282.922 64.04 279.082 68.008C275.285 71.976 269.781 73.96 262.57 73.96ZM262.57 66.344C266.453 66.344 269.375 65.0853 271.338 62.568C273.343 60.008 274.346 56.232 274.346 51.24C274.346 46.248 273.343 42.4933 271.338 39.976C269.375 37.416 266.453 36.136 262.57 36.136C258.645 36.136 255.679 37.416 253.674 39.976C251.711 42.4933 250.73 46.248 250.73 51.24C250.73 56.232 251.711 60.008 253.674 62.568C255.679 65.0853 258.645 66.344 262.57 66.344ZM303.553 73C302.87 73 302.358 72.872 302.017 72.616C301.676 72.36 301.356 71.8693 301.057 71.144L284.865 31.592C284.737 31.208 284.673 30.8667 284.673 30.568C284.673 29.8427 285.057 29.48 285.825 29.48H293.505C294.102 29.48 294.55 29.608 294.849 29.864C295.19 30.12 295.446 30.4827 295.617 30.952L305.857 58.408L316.097 30.952C316.438 29.9707 317.164 29.48 318.273 29.48H325.953C326.721 29.48 327.105 29.8427 327.105 30.568C327.105 30.8667 327.041 31.208 326.913 31.592L310.785 71.144C310.486 71.8693 310.145 72.36 309.761 72.616C309.42 72.872 308.908 73 308.225 73H303.553Z" fill="white"/>
            <rect x="336.899" y="65" width="76.431" height="8" fill="#22D3EE"/>
          </svg>
        </Link>
        
        <nav className="flex gap-1">
          {navItems.map((item) => {
            const isActive = isNavItemActive(item);
            const href = getNavItemHref(item);
            return (
              <Link
                key={item.href}
                href={href}
                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs ${
                  isActive 
                    ? 'bg-white/10 text-[#4a9eff] border border-white/10' 
                    : 'text-white/50 hover:text-white/80 hover:bg-white/5'
                }`}
              >
                <item.Icon className="w-3.5 h-3.5" strokeWidth={2} />
                <span>{item.label}</span>
              </Link>
            );
          })}
        </nav>

        <div className="flex-1" />
      </header>

      {/* Main Content */}
      <main className="flex-1 overflow-hidden bg-[#0d0d0d]">
        {children}
      </main>

      {/* Status Bar */}
      <footer className="h-6 bg-[#1a1a1a] border-t border-white/5 flex items-center px-4 text-[10px]">
        <div className="flex items-center gap-4 text-white/30">
          <span className="flex items-center gap-1">
            <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>
            Готово
          </span>
          <span>Кластеров: {clusters.length}</span>
          <span>Фильтров: {filters.length}</span>
        </div>
        <div className="flex-1" />
      </footer>
    </div>
  );
}
