#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ð° PostgreSQL
# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: bash quick_migrate.sh

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð½Ð° PostgreSQL - Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "database.json" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ„Ð°Ð¹Ð» database.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    echo "ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ vs-tools/backend"
    exit 1
fi

echo ""
echo "ðŸ“‹ Ð¨ÐÐ“ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if ! command -v python3 &> /dev/null; then
    echo "âŒ Python Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    exit 1
fi
echo "âœ… Python Ð½Ð°Ð¹Ð´ÐµÐ½: $(python3 --version)"

if ! python3 -c "import psycopg2" 2>/dev/null; then
    echo "âš ï¸  psycopg2 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ..."
    pip install psycopg2-binary > /dev/null
fi
echo "âœ… psycopg2 ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"

echo ""
echo "ðŸ“‹ Ð¨ÐÐ“ 2: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

BACKUP_FILE="database.json.backup.$(date +%Y%m%d_%H%M%S)"
cp database.json "$BACKUP_FILE"
echo "âœ… Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ: $BACKUP_FILE"

echo ""
echo "ðŸ“‹ Ð¨ÐÐ“ 3: Ð—Ð°Ð¿ÑƒÑÐº PostgreSQL"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v docker &> /dev/null; then
    if docker ps 2>/dev/null | grep -q postgres; then
        echo "âœ… PostgreSQL ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² Docker"
    else
        echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ PostgreSQL Ð² Docker..."
        docker-compose up -d postgres pgadmin
        echo "âœ… PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
        echo "   PgAdmin Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° http://localhost:5050"
        sleep 3
    fi
else
    echo "âš ï¸  Docker Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°"
    echo "   Ð£Ð±ÐµÐ´Ð¸ÑÑŒ Ñ‡Ñ‚Ð¾ PostgreSQL ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
    read -p "   ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo ""
echo "ðŸ“‹ Ð¨ÐÐ“ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ ! -f ".env" ]; then
    echo "âš ï¸  .env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÑŽ Ð¸Ð· Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°..."
    cp .env.example .env 2>/dev/null || cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=5432
DB_NAME=shar_messenger
DB_USER=postgres
DB_PASSWORD=postgres
USE_POSTGRES=false
KEEP_JSON_BACKUP=true
EOF
fi
echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ð°"

echo ""
echo "ðŸ“‹ Ð¨ÐÐ“ 5: Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
python3 migrate_to_postgres.py
MIGRATE_STATUS=$?

echo ""
if [ $MIGRATE_STATUS -eq 0 ]; then
    echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
    echo ""
    echo "ðŸ“‹ Ð¨ÐÐ“ 6: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    python3 db_switch.py status
    
    echo ""
    echo "ðŸ“‹ Ð¨ÐÐ“ 7: ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° PostgreSQL"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    read -p "ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ð½Ð° PostgreSQL? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        python3 db_switch.py to-postgres
        
        echo ""
        echo "ðŸ“‹ Ð¨ÐÐ“ 8: ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
        pkill -f "uvicorn main:app" || true
        sleep 2
        
        echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ PostgreSQL..."
        echo ""
        python3 main.py &
        sleep 3
        
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                   âœ… Ð“ÐžÐ¢ÐžÐ’Ðž!                              â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ PostgreSQL               â•‘"
        echo "â•‘                                                            â•‘"
        echo "â•‘ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ:                                                 â•‘"
        echo "â•‘   â€¢ API: curl http://localhost:8000/api/users             â•‘"
        echo "â•‘   â€¢ UI: http://localhost:3000 (Ð¸Ð»Ð¸ Ð²Ð°Ñˆ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´)          â•‘"
        echo "â•‘   â€¢ Ð‘Ð”: python db_switch.py status                        â•‘"
        echo "â•‘                                                            â•‘"
        echo "â•‘ ÐžÑ‚Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ:                                               â•‘"
        echo "â•‘   â€¢ Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ: $BACKUP_FILE             â•‘"
        echo "â•‘   â€¢ JSON Ð±Ð°Ð·Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°       â•‘"
        echo "â•‘   â€¢ Ð§Ð¸Ñ‚Ð°Ð¹ POSTGRES_QUICKSTART.md Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
    else
        echo "â­ï¸  ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ"
        echo "Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ð¿Ð¾Ð·Ð¶Ðµ, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸:"
        echo "  python db_switch.py to-postgres"
    fi
else
    echo "âŒ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð°ÑÑŒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹"
    echo ""
    echo "Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ:"
    echo "  1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ‡Ñ‚Ð¾ PostgreSQL Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚: docker ps"
    echo "  2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð² .env"
    echo "  3. Ð§Ð¸Ñ‚Ð°Ð¹ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹ÑˆÐµ"
    echo "  4. Ð˜Ð»Ð¸ Ð¾Ñ‚ÐºÑ€Ð¾Ð¹ÑÑ Ð² MIGRATION_GUIDE.md Ð·Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ"
    exit 1
fi
