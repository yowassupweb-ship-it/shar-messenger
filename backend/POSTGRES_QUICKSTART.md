# PostgreSQL Migration - Quick Start Guide

## üìå –ó–∞ 5 –º–∏–Ω—É—Ç

–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON –Ω–∞ PostgreSQL:

```bash
cd vs-tools/backend

# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL (–µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ)
docker-compose up -d

# 2. –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
python db_switch.py status

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
python db_switch.py migrate

# 4. –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ PostgreSQL
python db_switch.py to-postgres

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
pkill -f "uvicorn main:app"
python main.py
```

---

## üìã –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (~1 –º–∏–Ω)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ `database.json`
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (~5-30 —Å–µ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä—ë–º–∞)
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å —á–∞—Ç–æ–≤ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤/–ø—Ä–æ–¥—É–∫—Ç–æ–≤
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å —à–∞–±–ª–æ–Ω–æ–≤, –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ —Ç.–¥.

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ (~30 —Å–µ–∫)
- ‚úÖ –í—ã–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env`:

```env
# PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
DB_HOST=localhost           # –ê–¥—Ä–µ—Å –ë–î
DB_PORT=5432               # –ü–æ—Ä—Ç –ë–î
DB_NAME=shar_messenger     # –ò–º—è –ë–î
DB_USER=postgres           # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î
DB_PASSWORD=postgres       # –ü–∞—Ä–æ–ª—å –ë–î

# –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ë–î
USE_POSTGRES=false         # true –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è PostgreSQL
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ
python db_switch.py status

# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
# ‚úì Current Database: JSON (–∏–ª–∏ PostgreSQL)
# ‚úì Record Counts:
#   - users: X
#   - chats: X
#   - messages: X
#   - products: X
#   - data_sources: X
#   - feeds: X
```

---

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ JSON
```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pkill -f "uvicorn main:app"

# 2. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ JSON
python db_switch.py to-json

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
python main.py
```

### –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
# 1. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ PostgreSQL
docker-compose down -v

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
docker-compose up -d

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å–Ω–æ–≤–∞
python db_switch.py migrate
```

---

## üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –≥–∞–π–¥–∞ —Å–º. [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md)

---

## üéØ –¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# 1. –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
cd vs-tools/backend
docker-compose up -d          # –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL

# 2. –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
python db_switch.py status

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
python db_switch.py migrate

# 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç? –û—Ç–ª–∏—á–Ω–æ!
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

```bash
# 1. –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL
sudo apt install postgresql

# 2. –°–æ–∑–¥–∞—Ç—å –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo -u postgres psql << 'EOF'
CREATE DATABASE shar_messenger;
CREATE USER shar_app WITH PASSWORD 'strong_pass';
GRANT ALL PRIVILEGES ON DATABASE shar_messenger TO shar_app;
EOF

# 3. –ù–∞ –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É–¥–∞–ª—ë–Ω–Ω–æ–π –ë–î
# –û–±–Ω–æ–≤–∏—Ç—å .env:
# DB_HOST=prod-server.com
# DB_USER=shar_app
# DB_PASSWORD=strong_pass

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
python db_switch.py migrate

# 5. –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
python db_switch.py to-postgres
systemctl restart shar-backend
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å PostgreSQL –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ JSON

```bash
# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ JSON:
python db_switch.py to-json
systemctl restart shar-backend

# JSON –±–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ database.json - –≤—Å—ë –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
```

---

## üìä –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

- `schema.sql` - SQL —Å—Ö–µ–º–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- `db_postgres.py` - –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL
- `db_adapter.py` - –ê–¥–∞–ø—Ç–µ—Ä, –≤—ã–±–∏—Ä–∞—é—â–∏–π –º–µ–∂–¥—É JSON/PostgreSQL
- `migrate_to_postgres.py` - –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- `db_switch.py` - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- `MIGRATION_GUIDE.md` - –ü–æ–ª–Ω–∞—è –ø–æ—à–∞–≥–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `docker-compose.yml` - –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ PostgreSQL —á–µ—Ä–µ–∑ Docker

---

## üí° –°–æ–≤–µ—Ç—ã

1. **–í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π**
   ```bash
   cp database.json database.json.backup.$(date +%Y%m%d)
   ```

2. **–ü—Ä–æ–≤–µ—Ä—è–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º**
   ```bash
   python db_switch.py status
   ```

3. **–ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π ssl=true –¥–ª—è PostgreSQL**

4. **–ù–µ —É–¥–∞–ª—è–π database.json —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏** - –¥–µ—Ä–∂–∏ –Ω–µ–¥–µ–ª—é –∫–∞–∫ –ø–æ–¥—É—à–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

5. **–î–µ–ª–∞–π —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ pg_dump —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏**
   ```bash
   pg_dump -h localhost -U postgres shar_messenger > backup.sql
   ```

---

## üöÄ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ PostgreSQL
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ
- ‚úÖ –ú–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- ‚úÖ –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
- ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

–ù–∞—Å–ª–∞–∂–¥–∞–π—Å—è! üéâ
