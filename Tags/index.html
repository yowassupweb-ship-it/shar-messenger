<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор тегов изображений</title>
    <style>
        :root {
            --background: #1b1b2b;
            --foreground: #a6adc8;
            --card: #252538;
            --button: #94baf9;
            --border: #2a2a3e;
            --hover: #343452;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--foreground);
            min-height: 100vh;
            padding: 24px;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .icon-large {
            width: 48px;
            height: 48px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subtitle {
            opacity: 0.6;
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }
        
        .btn-primary {
            background: var(--button);
            color: var(--background);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: var(--card);
            color: var(--foreground);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--button);
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.2s;
        }
        
        .drop-zone.dragover {
            border-color: var(--button);
            background: rgba(148, 186, 249, 0.1);
        }
        
        .drop-zone-icon {
            margin-bottom: 12px;
            opacity: 0.6;
        }
        
        .drop-zone-icon svg {
            width: 48px;
            height: 48px;
        }
        
        .drop-zone-text {
            opacity: 0.6;
        }
        
        .drop-zone-hint {
            font-size: 12px;
            opacity: 0.4;
            margin-top: 8px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        select, input[type="text"] {
            padding: 10px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--foreground);
            font-size: 14px;
            outline: none;
        }
        
        select:focus, input:focus {
            border-color: var(--button);
        }
        
        .stats {
            margin-left: auto;
            font-size: 14px;
            opacity: 0.6;
        }
        
        .main-content {
            display: flex;
            gap: 24px;
        }
        
        .image-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .image-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .image-card:hover {
            border-color: var(--button);
        }
        
        .image-card.selected {
            border-color: var(--button);
            box-shadow: 0 0 0 3px rgba(148, 186, 249, 0.3);
        }
        
        .image-card-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
        }
        
        .image-card.selected .image-card-checkbox {
            background: var(--button);
            border-color: var(--button);
        }
        
        .image-card-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #22c55e;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            z-index: 5;
        }
        
        .image-card-preview {
            aspect-ratio: 16/10;
            background: rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .image-card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-card-info {
            padding: 12px;
        }
        
        .image-card-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .image-card-meta {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 4px;
        }
        
        .image-card-title {
            font-size: 11px;
            color: var(--button);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-panel {
            width: 320px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 24px;
        }
        
        .sidebar-panel h3 {
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            opacity: 0.6;
            margin-bottom: 6px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--foreground);
            font-size: 14px;
            resize: none;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--button);
            outline: none;
        }
        
        .keyword-input-row {
            display: flex;
            gap: 8px;
        }
        
        .keyword-input-row input {
            flex: 1;
        }
        
        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(148, 186, 249, 0.2);
            color: var(--button);
            border-radius: 4px;
            font-size: 12px;
        }
        
        .keyword-tag button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            opacity: 0.7;
        }
        
        .keyword-tag button:hover {
            opacity: 1;
            color: #ef4444;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 24px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
        }
        
        .modal-image {
            width: 50%;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .modal-content {
            width: 50%;
            padding: 24px;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .modal-header h2 {
            font-size: 18px;
            word-break: break-all;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--foreground);
            font-size: 24px;
            cursor: pointer;
            opacity: 0.5;
            padding: 0;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-meta {
            font-size: 13px;
            opacity: 0.5;
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 200;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success { background: #22c55e; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.6;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.6;
        }
        
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    Редактор тегов изображений
                </h1>
                <p class="subtitle">Массовое редактирование метаданных EXIF/IPTC</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Загрузить
                </button>
                <button class="btn btn-secondary" onclick="loadImages()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Обновить
                </button>
            </div>
        </div>
        
        <input type="file" id="fileInput" multiple accept="image/*">
        
        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <p class="drop-zone-text">Перетащите изображения сюда или нажмите "Загрузить"</p>
            <p class="drop-zone-hint">Поддерживаются: JPG, PNG, TIFF, WebP</p>
        </div>
        
        <div class="controls">
            <select id="filterSelect" onchange="applyFilter()">
                <option value="all">Все изображения</option>
                <option value="with-tags">С тегами</option>
                <option value="without-tags">Без тегов</option>
            </select>
            <button class="btn btn-secondary" onclick="toggleSelectAll()">
                Выбрать все
            </button>
            <span id="selectedCount" style="font-size: 14px; opacity: 0.6;"></span>
            <div class="stats" id="stats"></div>
        </div>
        
        <div class="main-content">
            <div class="image-grid" id="imageGrid">
                <div class="loading">Загрузка...</div>
            </div>
            
            <div class="sidebar-panel" id="bulkPanel" style="display: none;">
                <h3>Массовое редактирование (<span id="bulkCount">0</span>)</h3>
                
                <div class="form-group">
                    <label>Заголовок</label>
                    <input type="text" id="bulkTitle" placeholder="Оставьте пустым чтобы не менять">
                </div>
                
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="bulkDescription" rows="2" placeholder="Оставьте пустым чтобы не менять"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Источник (URL)</label>
                    <input type="text" id="bulkSource" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label>Ключевые слова</label>
                    <div class="keyword-input-row">
                        <input type="text" id="bulkKeywordInput" placeholder="Через запятую" onkeydown="if(event.key==='Enter')addBulkKeyword()">
                        <button class="btn btn-primary" onclick="addBulkKeyword()">+</button>
                    </div>
                    <div class="keywords-list" id="bulkKeywords"></div>
                </div>
                
                <div class="form-group">
                    <label>Автор</label>
                    <input type="text" id="bulkAuthor" placeholder="Оставьте пустым чтобы не менять">
                </div>
                
                <div class="form-group">
                    <label>Copyright</label>
                    <input type="text" id="bulkCopyright" placeholder="Оставьте пустым чтобы не менять">
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="applyBulkTags()">
                    Применить к выбранным
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-image">
                <img id="modalImage" src="" alt="">
            </div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalFilename"></h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <!-- Техническая информация (только чтение) -->
                <div class="exif-info" id="exifInfo" style="background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; color: var(--foreground);">
                </div>
                
                <!-- Редактируемые поля в 2 колонки -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Заголовок</label>
                        <input type="text" id="editTitle">
                    </div>
                    
                    <div class="form-group">
                        <label>Автор / Владелец</label>
                        <input type="text" id="editAuthor">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="editDescription" rows="2"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Источник (URL)</label>
                        <input type="text" id="editSource" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label>Copyright</label>
                        <input type="text" id="editCopyright">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ключевые слова</label>
                    <div class="keyword-input-row">
                        <input type="text" id="editKeywordInput" placeholder="Добавить через запятую" onkeydown="if(event.key==='Enter')addEditKeyword()">
                        <button class="btn btn-primary" onclick="addEditKeyword()">+</button>
                    </div>
                    <div class="keywords-list" id="editKeywords"></div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="saveImageTags()">Сохранить</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'http://117.117.117.235:8001';
        
        let images = [];
        let selectedImages = new Set();
        let currentFilter = 'all';
        let editingImage = null;
        let editKeywords = [];
        let bulkKeywords = [];
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Format file size
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Load images
        async function loadImages() {
            try {
                const response = await fetch(`${API_URL}/api/tags/images`);
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();
                images = data.images;
                renderImages();
            } catch (e) {
                document.getElementById('imageGrid').innerHTML = 
                    '<div class="empty-state">❌ Не удалось загрузить. Убедитесь что API запущен на порту 8001</div>';
            }
        }
        
        // Render images
        function renderImages() {
            const grid = document.getElementById('imageGrid');
            let filtered = images;
            
            if (currentFilter === 'with-tags') {
                filtered = images.filter(img => img.has_tags);
            } else if (currentFilter === 'without-tags') {
                filtered = images.filter(img => !img.has_tags);
            }
            
            document.getElementById('stats').textContent = `Всего: ${filtered.length} из ${images.length}`;
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state">Нет изображений</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(img => `
                <div class="image-card ${selectedImages.has(img.filename) ? 'selected' : ''}" data-filename="${img.filename}">
                    <div class="image-card-checkbox" onclick="event.stopPropagation(); toggleSelect('${img.filename}')">
                        ${selectedImages.has(img.filename) ? '✓' : ''}
                    </div>
                    ${img.has_tags ? '<div class="image-card-badge">Теги</div>' : ''}
                    <div class="image-card-preview" onclick="openEditModal('${img.filename}')">
                        <img src="${API_URL}/api/tags/images/${img.filename}/thumbnail" alt="${img.filename}" loading="lazy">
                    </div>
                    <div class="image-card-info" onclick="openEditModal('${img.filename}')">
                        <div class="image-card-name" title="${img.filename}">${img.filename}</div>
                        <div class="image-card-meta">${img.size[0]}×${img.size[1]} • ${formatSize(img.file_size)}</div>
                        ${img.tags.title ? `<div class="image-card-title">${img.tags.title}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            updateSelectedUI();
        }
        
        // Toggle selection
        function toggleSelect(filename) {
            if (selectedImages.has(filename)) {
                selectedImages.delete(filename);
            } else {
                selectedImages.add(filename);
            }
            renderImages();
        }
        
        // Toggle select all
        function toggleSelectAll() {
            const filtered = getFilteredImages();
            if (selectedImages.size === filtered.length) {
                selectedImages.clear();
            } else {
                filtered.forEach(img => selectedImages.add(img.filename));
            }
            renderImages();
        }
        
        // Get filtered images
        function getFilteredImages() {
            if (currentFilter === 'with-tags') return images.filter(img => img.has_tags);
            if (currentFilter === 'without-tags') return images.filter(img => !img.has_tags);
            return images;
        }
        
        // Update selected UI
        function updateSelectedUI() {
            const count = selectedImages.size;
            document.getElementById('selectedCount').textContent = count > 0 ? `Выбрано: ${count}` : '';
            document.getElementById('bulkPanel').style.display = count > 0 ? 'block' : 'none';
            document.getElementById('bulkCount').textContent = count;
        }
        
        // Apply filter
        function applyFilter() {
            currentFilter = document.getElementById('filterSelect').value;
            renderImages();
        }
        
        // Open edit modal
        function openEditModal(filename) {
            const img = images.find(i => i.filename === filename);
            if (!img) return;
            
            editingImage = img;
            editKeywords = [...(img.tags.keywords || [])];
            
            document.getElementById('modalFilename').textContent = filename;
            document.getElementById('modalImage').src = `${API_URL}/api/tags/images/${filename}/thumbnail`;
            
            // Техническая информация (только чтение) - компактно
            const t = img.tags;
            let exifHtml = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">';
            
            // Размер и формат
            exifHtml += `<div><b>Размер:</b> ${img.size[0]}×${img.size[1]}</div>`;
            exifHtml += `<div><b>Формат:</b> ${img.format}</div>`;
            exifHtml += `<div><b>Файл:</b> ${formatSize(img.file_size)}</div>`;
            
            // Камера
            if (t.make || t.model) exifHtml += `<div><b>Камера:</b> ${t.make || ''} ${t.model || ''}</div>`;
            if (t.software) exifHtml += `<div><b>ПО:</b> ${t.software}</div>`;
            
            // Даты
            if (t.datetime_original) exifHtml += `<div><b>Снято:</b> ${t.datetime_original}</div>`;
            if (t.datetime) exifHtml += `<div><b>Изменено:</b> ${t.datetime}</div>`;
            
            // Параметры съёмки
            if (t.exposure_time) exifHtml += `<div><b>Выдержка:</b> ${t.exposure_time}</div>`;
            if (t.f_number) exifHtml += `<div><b>Диафрагма:</b> ${t.f_number}</div>`;
            if (t.iso) exifHtml += `<div><b>ISO:</b> ${t.iso}</div>`;
            if (t.focal_length) exifHtml += `<div><b>Фокус:</b> ${t.focal_length}</div>`;
            if (t.focal_length_35mm) exifHtml += `<div><b>Экв. 35мм:</b> ${t.focal_length_35mm}</div>`;
            if (t.exposure_program) exifHtml += `<div><b>Режим:</b> ${t.exposure_program}</div>`;
            if (t.metering_mode) exifHtml += `<div><b>Замер:</b> ${t.metering_mode}</div>`;
            if (t.white_balance) exifHtml += `<div><b>ББ:</b> ${t.white_balance}</div>`;
            if (t.flash) exifHtml += `<div><b>Вспышка:</b> ${t.flash}</div>`;
            
            // GPS
            if (t.gps_latitude && t.gps_longitude) {
                exifHtml += `<div style="grid-column: span 2;"><b>GPS:</b> ${t.gps_latitude}, ${t.gps_longitude}`;
                if (t.gps_altitude) exifHtml += ` (${t.gps_altitude})`;
                exifHtml += `</div>`;
            }
            
            exifHtml += '</div>';
            document.getElementById('exifInfo').innerHTML = exifHtml;
            
            // Редактируемые поля
            document.getElementById('editTitle').value = t.title || '';
            document.getElementById('editDescription').value = t.description || '';
            document.getElementById('editSource').value = t.source || '';
            document.getElementById('editAuthor').value = t.author || '';
            document.getElementById('editCopyright').value = t.copyright || '';
            
            renderEditKeywords();
            
            document.getElementById('editModal').classList.add('active');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            editingImage = null;
        }
        
        // Render edit keywords
        function renderEditKeywords() {
            document.getElementById('editKeywords').innerHTML = editKeywords.map(kw => `
                <span class="keyword-tag">${kw}<button onclick="removeEditKeyword('${kw}')">&times;</button></span>
            `).join('');
        }
        
        // Add edit keyword
        function addEditKeyword() {
            const input = document.getElementById('editKeywordInput');
            const keywords = input.value.split(',').map(k => k.trim()).filter(k => k);
            keywords.forEach(kw => {
                if (!editKeywords.includes(kw)) editKeywords.push(kw);
            });
            input.value = '';
            renderEditKeywords();
        }
        
        // Remove edit keyword
        function removeEditKeyword(kw) {
            editKeywords = editKeywords.filter(k => k !== kw);
            renderEditKeywords();
        }
        
        // Save image tags
        async function saveImageTags() {
            if (!editingImage) return;
            
            const tags = {
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDescription').value,
                source: document.getElementById('editSource').value,
                keywords: editKeywords,
                author: document.getElementById('editAuthor').value,
                copyright: document.getElementById('editCopyright').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/tags/images/${editingImage.filename}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tags)
                });
                
                if (response.ok) {
                    showToast('Теги сохранены', 'success');
                    closeModal();
                    loadImages();
                } else {
                    showToast('Ошибка сохранения', 'error');
                }
            } catch (e) {
                showToast('Ошибка сохранения', 'error');
            }
        }
        
        // Bulk keywords
        function renderBulkKeywords() {
            document.getElementById('bulkKeywords').innerHTML = bulkKeywords.map(kw => `
                <span class="keyword-tag">${kw}<button onclick="removeBulkKeyword('${kw}')">&times;</button></span>
            `).join('');
        }
        
        function addBulkKeyword() {
            const input = document.getElementById('bulkKeywordInput');
            const keywords = input.value.split(',').map(k => k.trim()).filter(k => k);
            keywords.forEach(kw => {
                if (!bulkKeywords.includes(kw)) bulkKeywords.push(kw);
            });
            input.value = '';
            renderBulkKeywords();
        }
        
        function removeBulkKeyword(kw) {
            bulkKeywords = bulkKeywords.filter(k => k !== kw);
            renderBulkKeywords();
        }
        
        // Apply bulk tags
        async function applyBulkTags() {
            if (selectedImages.size === 0) {
                showToast('Выберите изображения', 'info');
                return;
            }
            
            const tags = {};
            const title = document.getElementById('bulkTitle').value;
            const description = document.getElementById('bulkDescription').value;
            const source = document.getElementById('bulkSource').value;
            const author = document.getElementById('bulkAuthor').value;
            const copyright = document.getElementById('bulkCopyright').value;
            
            if (title) tags.title = title;
            if (description) tags.description = description;
            if (source) tags.source = source;
            if (bulkKeywords.length > 0) tags.keywords = bulkKeywords;
            if (author) tags.author = author;
            if (copyright) tags.copyright = copyright;
            
            if (Object.keys(tags).length === 0) {
                showToast('Заполните хотя бы одно поле', 'info');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/tags/images/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filenames: Array.from(selectedImages),
                        tags: tags
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`Обновлено ${data.successful} из ${data.total}`, 'success');
                    selectedImages.clear();
                    bulkKeywords = [];
                    document.getElementById('bulkTitle').value = '';
                    document.getElementById('bulkDescription').value = '';
                    document.getElementById('bulkSource').value = '';
                    document.getElementById('bulkAuthor').value = '';
                    document.getElementById('bulkCopyright').value = '';
                    renderBulkKeywords();
                    loadImages();
                } else {
                    showToast('Ошибка', 'error');
                }
            } catch (e) {
                showToast('Ошибка', 'error');
            }
        }
        
        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files).filter(f => 
                f.type.startsWith('image/')
            );
            
            if (files.length > 0) {
                await uploadFiles(files);
            }
        });
        
        // File input
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                await uploadFiles(Array.from(e.target.files));
            }
        });
        
        // Upload files
        async function uploadFiles(files) {
            showToast(`Загрузка ${files.length} файлов...`, 'info');
            
            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            
            try {
                const response = await fetch(`${API_URL}/api/tags/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`Загружено: ${data.uploaded}`, 'success');
                    loadImages();
                } else {
                    showToast('Ошибка загрузки', 'error');
                }
            } catch (e) {
                showToast('Ошибка загрузки', 'error');
            }
        }
        
        // Close modal on click outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeModal();
        });
        
        // Escape to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Init
        loadImages();
    </script>
</body>
</html>
